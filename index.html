<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chosen Palette: Professional Blue & Slate -->
    <!-- Application Structure Plan: The application is now gated by a simple, hardcoded login screen. The main dashboard is hidden by default. On successful login, a session flag is set, the login screen is hidden, and the dashboard is shown. This provides basic access control without changing the underlying Firebase anonymous auth required for the database rules. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Access Control. Goal: Protect the dashboard. Viz/Method: A full-screen login form. Justification: Fulfills the user's request for user ID/password protection before accessing the main application. It uses sessionStorage to persist the login state. Library/Method: HTML, JS.
        - Report Info: Registered Company Name. Goal: Add critical business data. Viz/Method: Added a new text input to the form, a display field to the vendor card, and a new column to the Excel export. Justification: Captures essential vendor information as requested.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        /* Fixed Toggle CSS */
        .toggle-bg {
            position: relative;
            display: block;
            width: 2.75rem; /* w-11 */
            height: 1.5rem; /* h-6 */
            border-radius: 9999px;
            background-color: #e5e7eb; /* gray-200 */
            transition: background-color 0.2s ease-in-out;
        }
        .toggle-bg:after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            background-color: white;
            border-radius: 9999px;
            height: 1.25rem; /* h-5 */
            width: 1.25rem; /* w-5 */
            transition: transform 0.2s ease-in-out;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        input:checked + .toggle-bg {
            background-color: #2563eb; /* blue-600 */
        }
        input:checked + .toggle-bg:after {
            transform: translateX(100%);
        }
        /* Loading Spinner */
        #loading-overlay {
            background-color: rgba(241, 245, 249, 0.8);
        }
        .spinner {
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center bg-slate-100">
        <div class="bg-white p-8 rounded-xl shadow-md w-full max-w-md">
            <h1 class="text-2xl font-bold text-center text-slate-800 mb-6">Vendor Dashboard Login</h1>
            <form id="login-form">
                <div class="mb-4">
                    <label for="userId" class="block text-sm font-medium text-slate-700">User ID</label>
                    <input type="text" id="userId" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-slate-700">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500" required>
                </div>
                <p id="login-error" class="text-sm text-red-600 text-center mb-4 hidden">Invalid User ID or Password.</p>
                <button type="submit" class="w-full inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Login
                </button>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard-page" class="hidden">
        <!-- Loading Overlay -->
        <div id="loading-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="spinner h-12 w-12 rounded-full border-4 border-slate-200"></div>
        </div>

        <!-- Main Content -->
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="flex flex-col sm:flex-row justify-between items-start mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-slate-800">Vendor Dashboard</h1>
                    <p class="text-slate-500 mt-1">Manage and contact your holiday planning vendors.</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 mt-4 sm:mt-0 w-full sm:w-auto">
                    <button id="export-btn" class="inline-flex justify-center py-2 px-6 border border-slate-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Export to Excel
                    </button>
                    <button id="open-modal-btn" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Add New Vendor
                    </button>
                </div>
            </header>
            <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow">
                    <h3 class="text-sm font-medium text-slate-500">Total Vendors</h3>
                    <p id="total-vendors-stat" class="text-3xl font-bold text-slate-800 mt-2">0</p>
                </div>
            </section>
            <section id="vendor-list-section">
                <div id="vendor-list-container" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                <div id="empty-state" class="text-center py-16 bg-white rounded-xl shadow hidden">
                    <h3 class="text-xl font-semibold text-slate-700">Your vendor list is empty.</h3>
                    <p class="text-slate-500 mt-2">Click "Add New Vendor" to get started.</p>
                </div>
            </section>
        </div>
    </div>

    <!-- Add Vendor Modal -->
    <div id="vendor-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
        <div class="relative bg-white rounded-2xl shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-slate-200">
                <h2 class="text-2xl font-bold text-blue-800">Add New Vendor</h2>
                <button id="close-modal-btn" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto">
                <form id="add-vendor-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                         <div class="space-y-6">
                            <div>
                                <label for="vendorName" class="block text-sm font-medium text-slate-700">Vendor Name (Brand)</label>
                                <input type="text" id="vendorName" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label for="registeredCompanyName" class="block text-sm font-medium text-slate-700">Registered Company Name</label>
                                <input type="text" id="registeredCompanyName" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="cityZone" class="block text-sm font-medium text-slate-700">City / Zone</label>
                                <input type="text" id="cityZone" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500" required>
                            </div>
                             <div>
                                <label for="contactNumber" class="block text-sm font-medium text-slate-700">Contact Number (for Call)</label>
                                <input type="tel" id="contactNumber" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="whatsappNumber" class="block text-sm font-medium text-slate-700">WhatsApp Number</label>
                                <div class="flex mt-1">
                                    <select id="whatsappCountryCode" class="block w-auto px-3 py-2 bg-white border border-r-0 border-slate-300 rounded-l-md text-sm shadow-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"></select>
                                    <input type="tel" id="whatsappNumber" class="block flex-1 px-3 py-2 bg-white border border-slate-300 rounded-r-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="e.g. 9876543210">
                                </div>
                            </div>
                            <div class="space-y-4 pt-2">
                                <h3 class="text-md font-semibold text-slate-800 border-b pb-2">Company Details</h3>
                                <div class="flex items-center justify-between">
                                    <label for="yearOfEstablishment" class="text-sm font-medium text-slate-700">Year of Establishment</label>
                                    <input type="number" id="yearOfEstablishment" placeholder="e.g., 2010" class="w-1/2 mt-1 block px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-slate-700">GST Registered?</span>
                                    <label class="flex items-center cursor-pointer">
                                        <div class="relative"><input type="checkbox" id="isGstRegistered" class="sr-only"><div class="toggle-bg"></div></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div class="space-y-4">
                                <h3 class="text-md font-semibold text-slate-800 border-b pb-2">Fleet Details</h3>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-slate-700">Owns Fleet?</span>
                                    <label class="flex items-center cursor-pointer">
                                        <div class="relative"><input type="checkbox" id="hasOwnFleet" class="sr-only"><div class="toggle-bg"></div></div>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <label for="vehicleCount" class="text-sm font-medium text-slate-700">Total No. of Vehicles</label>
                                    <input type="number" id="vehicleCount" placeholder="e.g., 25" class="w-1/2 mt-1 block px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <h3 class="text-md font-semibold text-slate-800 border-b pb-2">Vehicle Types & Count</h3>
                                <div id="vehicle-types-container" class="space-y-2"></div>
                                <div class="flex gap-2 items-center pt-2">
                                    <input type="text" id="customVehicleName" placeholder="Custom Type (e.g., Minibus)" class="flex-grow block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                                    <input type="number" id="customVehicleCount" placeholder="No." class="w-16 block px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                                    <button type="button" id="add-custom-vehicle-btn" class="px-3 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">+</button>
                                </div>
                                <div id="custom-vehicle-tags" class="flex flex-wrap gap-2 mt-2"></div>
                            </div>
                             <div class="pt-4">
                                <label for="notes" class="block text-sm font-medium text-slate-700">Notes / Red Flags</label>
                                <textarea id="notes" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="flex justify-end items-center p-6 border-t border-slate-200">
                 <button type="submit" form="add-vendor-form" id="submit-vendor-btn" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Save Vendor</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-semibold text-slate-800">Are you sure?</h3>
            <p class="text-sm text-slate-500 mt-2">Do you really want to remove this vendor? This action cannot be undone.</p>
            <div class="mt-6 flex justify-center gap-4">
                <button id="cancel-remove-btn" class="py-2 px-6 border border-slate-300 text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50">Cancel</button>
                <button id="confirm-remove-btn" class="py-2 px-6 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700">Remove</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";

        // Login elements
        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        
        // Dashboard elements
        const addVendorForm = document.getElementById('add-vendor-form');
        const vendorListContainer = document.getElementById('vendor-list-container');
        const emptyState = document.getElementById('empty-state');
        const vendorModal = document.getElementById('vendor-modal');
        const openModalBtn = document.getElementById('open-modal-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const exportBtn = document.getElementById('export-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const countryCodeSelect = document.getElementById('whatsappCountryCode');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmRemoveBtn = document.getElementById('confirm-remove-btn');
        const cancelRemoveBtn = document.getElementById('cancel-remove-btn');
        const totalVendorsStat = document.getElementById('total-vendors-stat');
        const vehicleTypesContainer = document.getElementById('vehicle-types-container');
        const addCustomVehicleBtn = document.getElementById('add-custom-vehicle-btn');
        const customVehicleTagsContainer = document.getElementById('custom-vehicle-tags');
        
        const firebaseConfig = {
            apiKey: "AIzaSyAZ0eDXO8mGWJG9b5-F_eUqYnCmGnhJzkk",
            authDomain: "vendor-manager-a8ede.firebaseapp.com",
            projectId: "vendor-manager-a8ede",
            storageBucket: "vendor-manager-a8ede.appspot.com",
            messagingSenderId: "689330927875",
            appId: "1:689330927875:web:e52e9cb02132dab4af5136"
        };
        
        let db;
        let vendorsCollection;
        let vendors = [];
        let tempCustomVehicles = [];
        let vendorIdToDelete = null;
        const standardVehicleTypes = ['Sedan', 'SUV', 'Ertiga', 'Crysta', 'Tempo Traveller', 'Bus'];

        const countryCodes = [
            { name: 'India', code: '91' }, { name: 'USA', code: '1' }, { name: 'UK', code: '44' }, { name: 'Australia', code: '61' }, { name: 'Singapore', code: '65' }, { name: 'UAE', code: '971' },
            { name: 'Afghanistan', code: '93' }, { name: 'Albania', code: '355' }, { name: 'Algeria', code: '213' }, { name: 'Andorra', code: '376' }, { name: 'Angola', code: '244' },
            { name: 'Argentina', code: '54' }, { name: 'Armenia', code: '374' }, { name: 'Austria', code: '43' }, { name: 'Azerbaijan', code: '994' }, { name: 'Bahrain', code: '973' },
            { name: 'Bangladesh', code: '880' }, { name: 'Belarus', code: '375' }, { name: 'Belgium', code: '32' }, { name: 'Bhutan', code: '975' }, { name: 'Brazil', code: '55' },
            { name: 'Canada', code: '1' }, { name: 'China', code: '86' }, { name: 'Egypt', code: '20' }, { name: 'France', code: '33' }, { name: 'Germany', code: '49' },
            { name: 'Indonesia', code: '62' }, { name: 'Iran', code: '98' }, { name: 'Italy', code: '39' }, { name: 'Japan', code: '81' }, { name: 'Malaysia', code: '60' },
            { name: 'Maldives', code: '960' }, { name: 'Mexico', code: '52' }, { name: 'Nepal', code: '977' }, { name: 'Netherlands', code: '31' }, { name: 'New Zealand', code: '64' },
            { name: 'Nigeria', code: '234' }, { name: 'Oman', code: '968' }, { name: 'Pakistan', code: '92' }, { name: 'Qatar', code: '974' }, { name: 'Russia', code: '7' },
            { name: 'Saudi Arabia', code: '966' }, { name: 'South Africa', code: '27' }, { name: 'Sri Lanka', code: '94' }, { name: 'Switzerland', code: '41' }, { name: 'Thailand', code: '66' },
            { name: 'Turkey', code: '90' }, { name: 'Vietnam', code: '84' }
        ];

        function showDashboard() {
            loginPage.classList.add('hidden');
            dashboardPage.classList.remove('hidden');
            initializeFirebase();
        }

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                vendorsCollection = collection(db, "vendors");
                listenForVendors();
            } catch (error) {
                console.error("Firebase initialization error:", error);
                loadingOverlay.classList.remove('hidden');
                let errorMessage = `<div class="text-center p-4 bg-red-100 text-red-700 rounded-lg max-w-lg mx-auto">
                    <p class="font-bold">Firebase Connection Failed</p>`;
                if (error.code === 'auth/configuration-not-found') {
                    errorMessage += `<p class="text-sm mt-2"><b>Action Required:</b> Enable Anonymous Sign-In in your Firebase project.</p><ol class="text-left text-sm mt-2 list-decimal list-inside"><li>Go to the Firebase Console.</li><li>Select your project.</li><li>Click <b>Build > Authentication</b>.</li><li>Go to the <b>Sign-in method</b> tab.</li><li>Enable "Anonymous" sign-in.</li></ol>`;
                } else {
                    errorMessage += `<p class="text-sm mt-2">Please check your Firebase config and browser console.</p>`;
                }
                errorMessage += `</div>`;
                loadingOverlay.innerHTML = errorMessage;
            }
        }
        
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userId = document.getElementById('userId').value;
            const password = document.getElementById('password').value;

            if (userId === 'nithin' && password === '07112002') {
                sessionStorage.setItem('isLoggedIn', 'true');
                showDashboard();
            } else {
                loginError.classList.remove('hidden');
            }
        });

        function populateCountryCodes() {
            countryCodes.sort((a, b) => a.name.localeCompare(b.name));
            const india = countryCodes.find(c => c.code === '91');
            const others = countryCodes.filter(c => c.code !== '91');
            const sortedCountries = [india, ...others];
            sortedCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.code;
                option.textContent = `${country.name} (+${country.code})`;
                if (country.code === '91') option.selected = true;
                countryCodeSelect.appendChild(option);
            });
        }

        function listenForVendors() {
            onSnapshot(vendorsCollection, (snapshot) => {
                const fetchedVendors = [];
                snapshot.forEach((doc) => {
                    fetchedVendors.push({ ...doc.data(), id: doc.id });
                });
                vendors = fetchedVendors;
                renderVendors(vendors);
                loadingOverlay.classList.add('hidden');
            }, (error) => {
                console.error("Error fetching vendors: ", error);
                loadingOverlay.innerHTML = `<p class="text-red-600">Error fetching data. Check Firebase rules.</p>`;
            });
        }
        
        const initializeVehicleForm = () => {
            vehicleTypesContainer.innerHTML = '';
            standardVehicleTypes.forEach(type => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between gap-2';
                div.innerHTML = `<label class="text-sm text-slate-600">${type}</label><div class="flex items-center gap-2"><label class="flex items-center cursor-pointer"><div class="relative"><input type="checkbox" data-type="${type}" class="sr-only vehicle-type-checkbox"><div class="toggle-bg"></div></div></label><input type="number" data-type-count="${type}" placeholder="No." class="w-20 mt-1 block px-3 py-1 bg-white border border-slate-300 rounded-md text-sm shadow-sm" disabled></div>`;
                vehicleTypesContainer.appendChild(div);
            });
            tempCustomVehicles = [];
            customVehicleTagsContainer.innerHTML = '';
        };

        const updateDashboardStats = (vendorList) => {
             totalVendorsStat.textContent = vendorList.length;
        };

        const renderVendors = (vendorList) => {
            vendorListContainer.innerHTML = '';
            if (vendorList.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                vendorList.forEach((vendor) => {
                    const vehicleListHTML = vendor.vehicleTypes && vendor.vehicleTypes.length > 0 ? vendor.vehicleTypes.map(v => `<li class="flex justify-between"><span>${v.type}</span><span class="font-medium bg-slate-100 px-2 rounded-md">${v.count}</span></li>`).join('') : '<li class="text-slate-500">Not specified</li>';
                    const contactHTML = `${vendor.contactNumber ? `<a href="tel:${vendor.contactNumber}" class="text-blue-600 hover:underline">${vendor.contactNumber}</a>` : ''}${vendor.contactNumber && vendor.whatsappNumber ? `<span class="text-slate-400 mx-1">|</span>` : ''}${vendor.whatsappNumber ? `<a href="https://wa.me/${vendor.whatsappNumber.replace(/[^0-9]/g, '')}" target="_blank" class="text-green-600 hover:underline">${vendor.whatsappNumber} (WA)</a>` : ''}${!vendor.contactNumber && !vendor.whatsappNumber ? `<span class="text-slate-500">Not provided</span>` : ''}`;
                    const card = `<div class="bg-white p-6 rounded-xl shadow flex flex-col"><div class="flex-grow"><div class="mb-4"><h3 class="text-lg font-bold text-slate-800">${vendor.vendorName}</h3><p class="text-sm text-slate-500">${vendor.cityZone}</p><p class="text-sm mt-2">${contactHTML}</p></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4 mb-4 text-sm"><div class="space-y-2"><h4 class="font-semibold text-slate-600 border-b pb-1">Company</h4><div class="flex justify-between"><span>Registered:</span> <span class="font-semibold text-right truncate" title="${vendor.registeredCompanyName || ''}">${vendor.registeredCompanyName || 'N/A'}</span></div><div class="flex justify-between"><span>Established:</span> <span class="font-semibold">${vendor.yearOfEstablishment || 'N/A'}</span></div><div class="flex justify-between"><span>GST Registered:</span> <span class="font-semibold">${vendor.isGstRegistered ? 'Yes' : 'No'}</span></div></div><div class="space-y-2"><h4 class="font-semibold text-slate-600 border-b pb-1">Fleet</h4><div class="flex justify-between"><span>Owns Fleet:</span> <span class="font-semibold">${vendor.hasOwnFleet ? 'Yes' : 'No'}</span></div><div class="flex justify-between"><span>Total Vehicles:</span> <span class="font-semibold">${vendor.vehicleCount || 'N/A'}</span></div></div></div><div class="mb-4"><h4 class="text-sm font-semibold text-slate-600 border-b pb-1 mb-2">Vehicle Types</h4><ul class="text-sm space-y-1 text-slate-700 max-h-24 overflow-y-auto pr-2">${vehicleListHTML}</ul></div>${vendor.notes ? `<div class="mt-4 pt-2 border-t border-slate-200"><h4 class="text-sm font-semibold text-slate-600">Notes:</h4><p class="text-sm text-slate-600 whitespace-pre-wrap">${vendor.notes}</p></div>` : ''}</div><div class="mt-6 text-right"><button data-id="${vendor.id}" class="remove-btn text-sm font-medium text-red-600 hover:text-red-800">Remove Vendor</button></div></div>`;
                    vendorListContainer.innerHTML += card;
                });
            }
            updateDashboardStats(vendorList);
        };
        
        const openModal = () => vendorModal.classList.remove('hidden');
        const closeModal = () => vendorModal.classList.add('hidden');

        const exportToExcel = () => {
            if (vendors.length === 0) { alert("No vendor data to export."); return; }
            const dataForExport = vendors.map(v => ({
                'Vendor Name': v.vendorName, 'Registered Company Name': v.registeredCompanyName, 'City / Zone': v.cityZone, 'Contact Number': v.contactNumber, 'WhatsApp Number': v.whatsappNumber,
                'Year of Establishment': v.yearOfEstablishment, 'GST Registered': v.isGstRegistered ? 'Yes' : 'No', 'Owns Fleet': v.hasOwnFleet ? 'Yes' : 'No',
                'Total Vehicles': v.vehicleCount, 'Vehicle Types': v.vehicleTypes && v.vehicleTypes.length > 0 ? v.vehicleTypes.map(vt => `${vt.type} (${vt.count})`).join(', ') : 'N/A',
                'Notes / Red Flags': v.notes
            }));
            const worksheet = XLSX.utils.json_to_sheet(dataForExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Vendors");
            XLSX.writeFile(workbook, "VendorDetails.xlsx");
        };

        addVendorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = document.getElementById('submit-vendor-btn');
            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';
            const collectedVehicleTypes = [...tempCustomVehicles];
            document.querySelectorAll('.vehicle-type-checkbox:checked').forEach(c => {
                const type = c.dataset.type, countInput = document.querySelector(`input[data-type-count="${type}"]`), count = parseInt(countInput.value) || 0;
                if (count > 0) collectedVehicleTypes.push({ type, count });
            });
            const countryCode = document.getElementById('whatsappCountryCode').value, whatsappInput = document.getElementById('whatsappNumber').value.trim();
            let fullWhatsappNumber = '';
            if (whatsappInput) fullWhatsappNumber = `+${countryCode}${whatsappInput.replace(/\D/g,'')}`;
            const newVendor = {
                vendorName: document.getElementById('vendorName').value, registeredCompanyName: document.getElementById('registeredCompanyName').value,
                cityZone: document.getElementById('cityZone').value, contactNumber: document.getElementById('contactNumber').value, whatsappNumber: fullWhatsappNumber,
                yearOfEstablishment: document.getElementById('yearOfEstablishment').value, isGstRegistered: document.getElementById('isGstRegistered').checked,
                hasOwnFleet: document.getElementById('hasOwnFleet').checked, vehicleCount: document.getElementById('vehicleCount').value,
                vehicleTypes: collectedVehicleTypes, notes: document.getElementById('notes').value
            };
            try {
                await addDoc(vendorsCollection, newVendor);
                addVendorForm.reset();
                initializeVehicleForm();
                closeModal();
            } catch (error) {
                console.error("Error adding document: ", error);
                alert("Could not save vendor.");
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Save Vendor';
            }
        });

        vendorListContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-btn')) {
                vendorIdToDelete = e.target.dataset.id;
                confirmModal.classList.remove('hidden');
            }
        });

        cancelRemoveBtn.addEventListener('click', () => {
            vendorIdToDelete = null;
            confirmModal.classList.add('hidden');
        });

        confirmRemoveBtn.addEventListener('click', async () => {
            if (vendorIdToDelete) {
                try {
                    await deleteDoc(doc(db, "vendors", vendorIdToDelete));
                } catch (error) {
                    console.error("Error removing document: ", error);
                    alert("Could not remove vendor.");
                } finally {
                    vendorIdToDelete = null;
                    confirmModal.classList.add('hidden');
                }
            }
        });

        openModalBtn.addEventListener('click', openModal);
        closeModalBtn.addEventListener('click', closeModal);
        exportBtn.addEventListener('click', exportToExcel);
        vendorModal.addEventListener('click', (e) => { if (e.target === vendorModal) closeModal(); });

        vehicleTypesContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('vehicle-type-checkbox')) {
                const type = e.target.dataset.type, countInput = document.querySelector(`input[data-type-count="${type}"]`);
                countInput.disabled = !e.target.checked;
                if (!e.target.checked) countInput.value = '';
            }
        });

        addCustomVehicleBtn.addEventListener('click', () => {
            const nameInput = document.getElementById('customVehicleName'), countInput = document.getElementById('customVehicleCount'),
                  name = nameInput.value.trim(), count = parseInt(countInput.value);
            if (name && count > 0) {
                tempCustomVehicles.push({ type: name, count: count });
                renderCustomVehicleTags();
                nameInput.value = '';
                countInput.value = '';
            }
        });

        const renderCustomVehicleTags = () => {
            customVehicleTagsContainer.innerHTML = '';
            tempCustomVehicles.forEach((vehicle, index) => {
                const tag = document.createElement('div');
                tag.className = 'bg-blue-100 text-blue-800 text-xs font-medium pl-2 pr-1 py-1 rounded-full flex items-center gap-1';
                tag.innerHTML = `<span>${vehicle.type} (${vehicle.count})</span><button type="button" data-index="${index}" class="remove-custom-vehicle-btn font-bold">&times;</button>`;
                customVehicleTagsContainer.appendChild(tag);
            });
        };

        customVehicleTagsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-custom-vehicle-btn')) {
                const indexToRemove = parseInt(e.target.dataset.index);
                tempCustomVehicles.splice(indexToRemove, 1);
                renderCustomVehicleTags();
            }
        });

        // App Initialization
        if (sessionStorage.getItem('isLoggedIn') === 'true') {
            showDashboard();
        }
        populateCountryCodes();
        initializeVehicleForm();
    </script>
</body>
</html>

